name: CI to Docker Hub

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:

  build:
    runs-on: ubuntu-20.04

    strategy:
      matrix:
        mediawiki:
          - '1.39':
            default: '8.1'
            versions:
              - '7.4'
              - '8.0'
              - '8.1'
          - '1.38':
            default: '7.4'
            versions:
              - '7.4'
              - '8.0'
              - '8.1'
          - '1.35':
            default: '7.4'
            versions:
              - '7.4'
              - '8.0'
              - '8.1'
        variant: [apache]

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Run update.sh / generate Dockerfiles
        run: |
          chmod +x update.sh
          ./update.sh
          
      - name: echo vars
        run: |
          echo "mw version ${{matrix.mediawiki}} with php ${{matrix.mediawiki.versions}} and default ${{matrix.mediawiki.default}}"
    
      # - name: Retrieve MediaWiki version
      #   run: |
      #     echo "TAG_NAME=$(cat ./${{ matrix.mediawiki_version }}/${{ matrix.php_version }}/${{ matrix.variant }}/Dockerfile | sed -n -e 's/^.*ENV MEDIAWIKI_VERSION //p')" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v2
        with:
          driver-opts: network=host

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache/${{ matrix.mediawiki_version }}/${{ matrix.variant }}
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-


      # - uses: docker/login-action@v2
      #   with:
      #     username: ${{ secrets.DOCKER_HUB_USERNAME }}
      #     password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      # - name: Build and push
      #   id: docker_build
      #   uses: docker/build-push-action@v4
      #   with:
      #     context: ./
      #     file: ./${{ matrix.mediawiki_version }}/${{ matrix.variant }}/Dockerfile
      #     network: host
      #     allow: network.host
      #     build-args: |
      #        CACHEBUST=${{ steps.date.outputs.date }}
      #     builder: ${{ steps.buildx.outputs.name }}
      #     push: true
      #     tags: gesinn/docker-mediawiki-base-${{ matrix.variant }}:${{ matrix.mediawiki_version }}, gesinn/docker-mediawiki-base-${{ matrix.variant }}:${{ env.TAG_NAME }}
      #     cache-from: type=local,src=/tmp/.buildx-cache/${{ matrix.mediawiki_version }}/${{ matrix.variant }}
      #     cache-to: type=local,dest=/tmp/.buildx-cache/${{ matrix.mediawiki_version }}/${{ matrix.variant }}

      # - name: Image digest
      #   run: echo ${{ steps.docker_build.outputs.digest }}
